---
title: "MEGA_Epic_Custom"
author: "Corey Cox"
date: "9/2/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

max_na <- function(...) {
  ifelse(! all(is.na(...)), max(..., na.rm = TRUE), NA_real_)
}
```

## Create Sample Manifests for MEGA, Epic, and Custom Methylation Arrays
Top priority for any sample that has any other omics data is to run the MEGA. Then for any additional sample remaining we need to run the Epic and then the Custom Methylation array chips. First we'll examine what subjects have sample information. Next we'll create a sample list for the MEGA sample prioritizing using Blood Clot DNA or PBMC DNA. Any samples which we don't have enough DNA without using Nasal DNA we'll have to run MEGA with Nasal DNA; this will reduce the sample avaible for other omics so is best avioded if possible. Then we'll create sample lists for the Epic and Custom Methylation chips. We'll use the Sample Manifest App to create Manifests for each of these data-sets.

## Load and Explore Blood Clot, PBMC DNA, and Nasal DNA

```{r load_DNA_data}
blood_clots_all <- "MEGA_Epic_Custom_InputData/CAAPA2_blood_clot_DNA_master_updated_082821.xlsx" %>%
  read_excel() %>%
  mutate(subject = Subject_ID1 %>% str_extract("[[:digit:]]{8}") %>% as.double(),
         # fix some data entry errors
         subject = ifelse(subject == 10306066, 10206082, subject),
         Subject_ID1 = ifelse(subject == 10206082, 10206082, Subject_ID1),
         Subject_ID2 = ifelse(subject == 10206082, 10306066, Subject_ID2),
         Site = ifelse(subject == 10201057, "Denver", Site),
         Site = ifelse(subject == 10204064, "WashingtonDC", Site),
         Tissue = "Blood") %>%
  select(subject, everything(), Addl_Notes = ...14)

# Used for testing data integrity... no longer needed
# blood_clots_nested <- blood_clots_all %>%
#   nest_by(subject, Site, Tissue) %>%
#   mutate(num_samples = data %>% nrow(),
#          max_ng_ul = data$`ng/ul` %>% max_na(),
#          max_Total_ug = data$`Total, ug` %>% max_na(),
#          max_Total_ug = ifelse(is.na(max_Total_ug), max_ng_ul / 10, max_Total_ug),
#          not_sent = data$Notes %>% na.omit() %>% str_c("") %>% str_detect("not sent") %>% all() %>% ifelse(., "not sent", ""))

blood_clots_data <- blood_clots_all %>%
  group_by(subject) %>%
  arrange(`ng/ul`) %>%
  slice_head() %>%
  ungroup()

pbmc_dna <- "MEGA_Epic_Custom_InputData/PBMC_DNA_Final_for_plots_local_sites_ONLY_082921.csv" %>% read_csv()
nasal_dna <- "MEGA_Epic_Custom_InputData/Nasal_DNA_Final_for_plots_local_sites_ONLY_082921.csv" %>% read_csv()

all_data <- blood_clots_data %>%
  full_join(pbmc_dna, by = "subject") %>%
  full_join(nasal_dna, by = "subject", suffix = c("_pbmc", "_nasal"))
```

```{r psomagen_data}
psomagen <- list.files(path = "MEGA_Epic_Custom_InputData/", pattern = "Psomagen", full.names = TRUE) %>%
  set_names() %>%
  map(~ read_excel(.x, range = "B25:R321",
                   col_names = c("Sample ID", "Container ID", "Well ID", "Species", "Sample Status", "Sample Type", "Need Prep?", "Sample Buffer", "Sample Conc",
                                 "Volume", "Library Type", "Library", "Sequencing Coverage Unit", "Sequencing Coverage", "Read Length", "Analysis", "Data Delivery"))) %>%
  reduce(bind_rows) %>%
  filter(! is.na(`Sample ID`), `Sample ID` != "EMPTY")

missing_psomagen <- psomagen %>% filter(!`Sample ID` %in% all_data$subject)
```

```{r subject_list}
subject_list <- all_data %>%
  mutate(
    MEGA_Sample = case_when(
      `ng/ul` >= 40 ~ "Blood Clot",
      TOTAL_Qubit_ug_pbmc >= 0.2 ~ "PBMC",
      Conc_Nanodrop_pbmc >= 40 ~ "PBMC",
      TOTAL_Qubit_ug_nasal >= 0.2 ~ "Nasal",
      Conc_Nanodrop_nasal >= 40 ~ "Nasal",
      TRUE ~ "Failed"),
    Epic_Sample = case_when(
      Site %in% c("Brazil", "Barbados", "Nigeria") ~ "",
      MEGA_Sample != "Nasal" & TOTAL_Qubit_ug_nasal >= 0.5 ~ "",
      MEGA_Sample != "Nasal" & TOTAL_Nanodrop_ug_nasal >= 0.6 ~ "",
      MEGA_Sample == "Nasal" & TOTAL_Qubit_ug_nasal >= 0.7 ~ "",
      MEGA_Sample == "Nasal" & TOTAL_Nanodrop_ug_nasal >= 0.8 ~ "",
      TRUE ~ "Failed"
    ),
    Custom_Sample = case_when(
      Site %in% c("Brazil", "Barbados", "Nigeria") ~ "",
      MEGA_Sample != "Nasal" & TOTAL_Qubit_ug_nasal >= 1.0 ~ "",
      MEGA_Sample == "Nasal" & TOTAL_Qubit_ug_nasal >= 1.2 ~ "",
      TRUE ~ "Failed"
    ),
    MEGA_Status_Info = case_when(
      MEGA_Sample == "Failed" & Addl_Notes == "Re-extract" ~ "Notes say re-extract, status?",
      ! is.na(`ng/ul`) & `ng/ul` < 40 ~ "Blood Clot DNA < 40 ng/ul",
      MEGA_Sample == "Failed" & is.na(`ng/ul`) ~ "No Blood Clot DNA data, waiting for extraction?",
      TRUE ~ ""
    ),
    Epic_Status_Info = case_when(
      Site %in% c("Brazil", "Barbados", "Nigeria") ~ "Excluded",
      MEGA_Sample == "Nasal" & (is.na(TOTAL_Qubit_ug_nasal) | TOTAL_Qubit_ug_nasal < 0.2) ~ "Missing Nasal Qubit",
      TOTAL_Qubit_ug_nasal < 0 & TOTAL_Nanodrop_ug_nasal < 0.6 ~ "Missing Nasal Qubit, Nanodrop < 0.6 ug",
      TOTAL_Nanodrop_ug_nasal == -5 ~ "Nasal Nanodrop == -5, did sample fail?",
      is.na(TOTAL_Nanodrop_ug_nasal) ~ "No Nasal DNA data",
      TRUE ~ ""
    ),
    Custom_Status_Info = case_when(
      Site %in% c("Brazil", "Barbados", "Nigeria") ~ "Excluded",
      Epic_Sample == "Failed" ~ "",
      TOTAL_Qubit_ug_nasal < 1.0 ~ "Qubit Nasal < 1 ug",
      TOTAL_Qubit_ug_nasal < 1.2 ~ "Qubit Nasal < 1.2 ug and MEGA sample is Nasal DNA",
      TRUE ~ ""
    )
  )

mega_failed_samples <- subject_list %>%
  filter(MEGA_Sample == "Failed")

epic_failed_samples <- subject_list %>%
  # filter(Epic_Sample == "Failed")
  filter(MEGA_Sample != "Failed", Epic_Sample == "Failed")

custom_failed_samples <- subject_list %>%
  # filter(Custom_Sample == "Failed")
  filter(MEGA_Sample != "Failed", Epic_Sample != "Failed", Custom_Sample == "Failed")

failed_no_notes <- subject_list %>%
  filter(
    (MEGA_Sample == "Failed" & MEGA_Status_Info == "") |
    (Epic_Sample == "Failed" & Epic_Status_Info == "") |
    (Custom_Sample == "Failed" & Custom_Status_Info == "" & Epic_Sample != "Failed"))

subject_list %>% write_tsv("MEGA_Epic_Custom_InputData/CAAPA2_DNA_chip_survey.tsv")
```


